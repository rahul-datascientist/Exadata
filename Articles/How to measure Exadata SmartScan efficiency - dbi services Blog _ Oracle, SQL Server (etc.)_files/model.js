(function(){var e=function(e){var t=this;e.require().script("mvc/class","mvc/lang.string").done(function(){var n=function(){var t=e.String,n=t.getObject,r=t.underscore,i=t.classize,s=e.isArray,o=e.makeArray,u=e.extend,a=e.each,f=function(t,n,r){e.event.trigger(n,r,t,!0)},l=function(n,r,i,o,a,f,l){if(typeof n=="string"){var c=n.indexOf(" ");c>-1?n={url:n.substr(c+1),type:n.substr(0,c)}:n={url:n}}return n.data=typeof r=="object"&&!s(r)?u(n.data||{},r):r,n.url=t.sub(n.url,n.data,!0),e.ajax(u({type:f||"post",dataType:l||"json",fixture:a,success:i,error:o},n))},c=function(t,n,i){var s=r(t.shortName),o="-"+s+(n||"");return e.fixture&&e.fixture[o]?o:i||"//"+r(t.fullName).replace(/\.models\..*/,"").replace(/\./g,"/")+"/fixtures/"+s+(n||"")+".json"},h=function(e,n,r){n=n||{};var i=e.id;return n[i]&&n[i]!==r&&(n["new"+t.capitalize(r)]=n[i],delete n[i]),n[i]=r,n},p=function(t){var n=t||e.Model.List||Array;return new n},d=function(e){return e[e.constructor.id]},v=function(e){var t=[];return a(e,function(e,n){n["__u Nique"]||(t.push(n),n["__u Nique"]=1)}),a(t,function(e,t){delete t["__u Nique"]})},m=function(t,n,r,i,s){var o=e.Deferred(),u=function(e){t[s||n+"d"](e),o.resolveWith(t,[t,e,n])},a=function(e){o.rejectWith(t,[e])},f=[t.serialize(),u,a],l=t.constructor,c,h=o.promise();return n=="destroy"&&f.shift(),n!=="create"&&f.unshift(d(t)),o.then(r),o.fail(i),c=l[n].apply(l,f),c&&c.abort&&(h.abort=function(){c.abort()}),h},g=function(e){return typeof e=="object"&&e!==null&&e},y=function(t){return function(n,r){return e.fn[t].apply(e([this]),arguments)}},b=y("bind"),w=y("unbind"),E="constructor";ajaxMethods={create:function(e){return function(t,n,r){return l(e||this._shortName,t,n,r,c(this,"Create","-restCreate"))}},update:function(e){return function(t,n,r,i){return l(e||this._shortName+"/{"+this.id+"}",h(this,n,t),r,i,c(this,"Update","-restUpdate"),"put")}},destroy:function(e){return function(t,n,r){var i={};return i[this.id]=t,l(e||this._shortName+"/{"+this.id+"}",i,n,r,c(this,"Destroy","-restDestroy"),"delete")}},findAll:function(e){return function(t,n,r){return l(e||this._shortName,t,n,r,c(this,"s"),"get","json "+this._shortName+".models")}},findOne:function(e){return function(t,n,r){return l(e||this._shortName+"/{"+this.id+"}",t,n,r,c(this),"get","json "+this._shortName+".model")}}},e.Class(e.globalNamespace+".Model",{setup:function(t,n,i){var s=this,o=this.fullName;a(["attributes","validations"],function(e,n){if(!s[n]||t[n]===s[n])s[n]={}}),a(["convert","serialize"],function(e,n){t[n]!=s[n]&&(s[n]=u({},t[n],s[n]))}),this._fullName=r(o.replace(/\./g,"_")),this._shortName=r(this.shortName);if(o.indexOf(e.globalNamespace)==0)return;this.listType&&(this.list=new this.listType([])),a(ajaxMethods,function(e,t){var n=s[e];typeof n!="function"&&(s[e]=t(n))});var f={},l="* "+this._shortName+".model";f[l+"s"]=this.proxy("models"),f[l]=this.proxy("model"),e.ajaxSetup({converters:f})},attributes:{},model:function(e){return e?(e instanceof this&&(e=e.serialize()),new this(g(e[this._shortName])||g(e.data)||g(e.attributes)||e)):null},models:function(t){if(!t)return null;var n=p(this.List),r=s(t),i=e.Model.List,o=i&&t instanceof i,u=r?t:o?t.serialize():t.data,f=u?u.length:null,l=0;for(;l<f;l++)n.push(this.model(u[l]));return r||a(t,function(e,t){e!=="data"&&(n[e]=t)}),n},id:"id",addAttr:function(e,t){var n,r=this.attributes;return n=r[e]||(r[e]=t),t},convert:{date:function(e){var t=typeof e;return t==="string"?isNaN(Date.parse(e))?null:Date.parse(e):t==="number"?new Date(e):e},number:function(e){return parseFloat(e)},"boolean":function(e){return Boolean(e==="false"?0:e)},"default":function(e,t,r){var i=n(r),s=window,o;return r.indexOf(".")>=0&&(o=r.substring(0,r.lastIndexOf(".")),s=n(o)),typeof i=="function"?i.call(s,e):e}},serialize:{"default":function(e,t){return g(e)&&e.serialize?e.serialize():e},date:function(e){return e&&e.getTime()}},bind:b,unbind:w,_ajax:l},{setup:function(e){this._init=!0,this.attrs(u({},this.constructor.defaults,e)),delete this._init},update:function(e,t,n){return this.attrs(e),this.save(t,n)},errors:function(t){t&&(t=s(t)?t:o(arguments));var n={},r=this,i,u=function(e,t){a(t,function(t,i){var s=i.call(r);s&&(n[e]||(n[e]=[]),n[e].push(s))})},f=this.constructor.validations;return a(t||f||{},function(e,t){typeof e=="number"&&(e=t,t=f[e]),u(e,t||[])}),e.isEmptyObject(n)?null:n},attr:function(e,t,n,r){var s=i(e),o="get"+s;if(t!==undefined){var u="set"+s,a=this[e],l=this,c=function(t){var n;n=r&&r.call(l,t),f(l,"error."+e,t)};if(this[u]&&(t=this[u](t,this.proxy("_updateProperty",e,t,a,n,c),c))===undefined)return;return this._updateProperty(e,t,a,n,c),this}return this[o]?this[o]():this[e]},bind:b,unbind:w,_updateProperty:function(e,t,n,r,i){var s=this.constructor,o,u=s.attributes[e]||s.addAttr(e,"string"),a=s.convert[u]||s.convert["default"],l=null,c="",h="updated.",p,d,v=r,m=s.list;o=this[e]=t===null?null:a.call(s,t,function(){},u),this._init||(l=this.errors(e)),p=[o],d=[e,o,n],l&&(c=h="error.",v=i,d.splice(1,0,l),p.unshift(l)),n!==o&&!this._init&&(!l&&f(this,c+e,p),f(this,h+"attr",d)),v&&v.apply(this,p),e===s.id&&o!==null&&m&&(n?n!=o&&(m.remove(n),m.push(this)):m.push(this))},removeAttr:function(e){var t=this[e],n=!1,r=this.constructor.attributes;this[e]&&delete this[e],r[e]&&(delete r[e],n=!0),!this._init&&n&&t&&f(this,"updated.attr",[e,null,t])},attrs:function(e){var t,n=this.constructor,r=n.attributes;if(!e){e={};for(t in r)r.hasOwnProperty(t)&&(e[t]=this.attr(t))}else{var i=n.id;for(t in e)t!=i&&this.attr(t,e[t]);i in e&&this.attr(i,e[i])}return e},serialize:function(){var e=this.constructor,t=e.attributes,n,r,i={},s;attributes={};for(s in t)t.hasOwnProperty(s)&&(n=t[s],r=e.serialize[n]||e.serialize["default"],i[s]=r.call(e,this[s],n));return i},isNew:function(){var e=d(this);return e===undefined||e===null||e===""},save:function(e,t){return m(this,this.isNew()?"create":"update",e,t)},destroy:function(e,t){return m(this,"destroy",e,t,"destroyed")},identity:function(){var e=d(this),t=this.constructor;return(t._fullName+"_"+(t.escapeIdentity?encodeURIComponent(e):e)).replace(/ /g,"_")},elements:function(t){var n=this.identity();return this.constructor.escapeIdentity&&(n=n.replace(/([ #;&,.+*~\'%:"!^$[\]()=>|\/])/g,"\\$1")),e("."+n,t)},hookup:function(t){var n=this.constructor._shortName,r=e.data(t,"models")||e.data(t,"models",{});e(t).addClass(n+" "+this.identity()),r[n]=this}}),a(["created","updated","destroyed"],function(t,n){e.Model.prototype[n]=function(e){var t,r=this.constructor;return n==="destroyed"&&r.list&&r.list.remove(d(this)),t=e&&typeof e=="object"&&this.attrs(e.attrs?e.attrs():e),f(this,n),f(r,n,this),[this].concat(o(arguments))}}),e.fn.models=function(t){var n=[],r,i,s;return this.each(function(){a(e.data(this,"models")||{},function(e,t){r=r===undefined?t.constructor.List||null:t.constructor.List===r?r:null,n.push(t)})}),i=p(r),i.push.apply(i,v(n)),i},e.fn.model=function(t){return t&&t instanceof e.Model?(t.hookup(this[0]),this):this.models.apply(this,arguments)[0]}};n(),t.resolveWith(n)})};dispatch("mvc/model").containing(e).to("Foundry/2.1 Modules")})();